<section id="commander">
  <div class="card">
    <h2 class="section-title">Composer votre commande & calculer le total</h2>
    <p class="section-sub">
      Choisissez le nombre de bouteilles souhait√©, indiquez si vous pr√©f√©rez une
      livraison ou un retrait √† Ixelles, et le montant total √† payer sera calcul√©
      automatiquement. Ensuite, vous pourrez cliquer sur le bouton pour payer via Revolut.
    </p>

    <p class="section-sub" style="font-weight:600;">
      üìç Zone de livraison : uniquement <strong>Uccle</strong>, <strong>Ixelles</strong>
      et un rayon d‚Äôenviron <strong>3&nbsp;km</strong> autour.  
      En dehors de cette zone, la commande se fait en
      <strong>retrait √† Ixelles sur rendez-vous (contact par e-mail)</strong>.
    </p>

    <!-- Lignes de produits -->
    <div style="margin-top:18px; display:grid; gap:10px;">
      <!-- Bouteille 250 ml -->
      <div
        class="product-line"
        data-price="8"
        style="display:flex; flex-wrap:wrap; align-items:center; gap:10px; justify-content:space-between; border-bottom:1px solid #e2dfd4; padding-bottom:8px;"
      >
        <div>
          <strong>Bouteille 250&nbsp;ml</strong>
          <div style="font-size:0.9rem; color:#555;">
            Id√©ale pour d√©couvrir l‚Äôhuile ou pour offrir.  
            <span class="unit-price-250"><strong>8&nbsp;‚Ç¨</strong> / bouteille</span>
          </div>
        </div>
        <div>
          <label for="qty-250" style="font-size:0.9rem; font-weight:600;">Quantit√©</label>
          <input
            id="qty-250"
            type="number"
            min="0"
            value="0"
            style="width:80px; padding:6px 8px; border-radius:10px; border:1px solid #c9c1ad;"
          />
        </div>
      </div>

      <!-- Bouteille 750 ml -->
      <div
        class="product-line"
        data-price="15"
        style="display:flex; flex-wrap:wrap; align-items:center; gap:10px; justify-content:space-between; border-bottom:1px solid #e2dfd4; padding-bottom:8px;"
      >
        <div>
          <strong>Bouteille 750&nbsp;ml</strong>
          <div style="font-size:0.9rem; color:#555;">
            Format ‚Äúfamille‚Äù pour la cuisine du quotidien.  
            <span class="unit-price-750"><strong>15&nbsp;‚Ç¨</strong> / bouteille</span>
          </div>
        </div>
        <div>
          <label for="qty-750" style="font-size:0.9rem; font-weight:600;">Quantit√©</label>
          <input
            id="qty-750"
            type="number"
            min="0"
            value="0"
            style="width:80px; padding:6px 8px; border-radius:10px; border:1px solid #c9c1ad;"
          />
        </div>
      </div>
    </div>

    <!-- Livraison / retrait -->
    <div style="margin-top:18px;">
      <h3 style="margin:0 0 8px; font-size:1.05rem; color:#1c2a17;">
        Livraison ou retrait
      </h3>
      <p class="section-sub" style="margin-bottom:10px;">
        Merci de choisir l‚Äôoption qui vous convient :
      </p>

      <div style="display:grid; gap:6px; font-size:0.95rem;">
        <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
          <input
            type="radio"
            name="delivery-option"
            id="option-livraison"
            value="livraison"
            style="margin-top:3px;"
          />
          <span>
            <strong>Livraison √† domicile (+ 5&nbsp;‚Ç¨)</strong><br />
            Disponible uniquement sur Uccle, Ixelles et dans un rayon de ~3&nbsp;km.
          </span>
        </label>

        <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
          <input
            type="radio"
            name="delivery-option"
            id="option-retrait"
            value="retrait"
            style="margin-top:3px;"
          />
          <span>
            <strong>Retrait √† Ixelles (gratuit)</strong><br />
            Sur rendez-vous, en prenant contact par e-mail :
            <a href="mailto:arnaudvanderstraten@gmail.com">arnaudvanderstraten@gmail.com</a>
          </span>
        </label>
      </div>
    </div>

    <!-- R√©capitulatif -->
    <div
      style="margin-top:20px; padding:14px 16px; border-radius:16px; background:#f3efe5; font-size:0.95rem;"
    >
      <h3 style="margin:0 0 10px; font-size:1.05rem; color:#1c2a17;">
        R√©capitulatif
      </h3>
      <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
        <span>Sous-total bouteilles</span>
        <span><strong><span id="summary-subtotal">0,00</span>&nbsp;‚Ç¨</strong></span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
        <span>Frais de livraison</span>
        <span><strong><span id="summary-delivery">0,00</span>&nbsp;‚Ç¨</strong></span>
      </div>
      <div style="border-top:1px solid #d0c7b7; margin:8px 0;"></div>
      <div style="display:flex; justify-content:space-between; font-size:1.05rem;">
        <span>Total √† payer</span>
        <span><strong><span id="summary-total">0,00</span>&nbsp;‚Ç¨</strong></span>
      </div>
      <p
        style="margin-top:8px; font-size:0.8rem; color:#666; line-height:1.4;"
      >
        Les prix indiqu√©s peuvent √™tre ajust√©s selon la campagne d‚Äôhuile en cours.
        Le montant total affich√© est celui que vous devrez encoder lors du paiement
        via Revolut.
      </p>
    </div>

    <!-- Bouton de paiement Revolut -->
    <div style="margin-top:18px; display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
      <button
        id="pay-button"
        type="button"
        class="btn-main"
        style="border:none; cursor:pointer;"
      >
        üí≥ Payer via Revolut
      </button>
      <p style="font-size:0.85rem; color:#555; max-width:420px; margin:0;">
        En cliquant sur le bouton, vous serez redirig√© vers Revolut.  
        Merci d‚Äô<strong>encoder le montant total indiqu√©</strong> dans le r√©capitulatif.
      </p>
    </div>
  </div>

  <!-- Script de calcul du total -->
  <script>
    (function () {
      const qty250Input = document.getElementById("qty-250");
      const qty750Input = document.getElementById("qty-750");
      const deliveryRadios = document.querySelectorAll(
        'input[name="delivery-option"]'
      );

      const subtotalSpan = document.getElementById("summary-subtotal");
      const deliverySpan = document.getElementById("summary-delivery");
      const totalSpan = document.getElementById("summary-total");
      const payButton = document.getElementById("pay-button");

      // ‚ö†Ô∏è IMPORTANT : remplace ce lien par ton lien Revolut.me
      const REVOLUT_LINK = "https://revolut.me/TONPSEUDO";

      let lastTotal = 0;

      function getPriceFromLine(inputEl) {
        // On lit le prix dans l'attribut data-price du parent .product-line
        const line = inputEl.closest(".product-line");
        if (!line) return 0;
        const price = parseFloat(line.dataset.price);
        return isNaN(price) ? 0 : price;
      }

      function getSelectedDeliveryOption() {
        let value = null;
        deliveryRadios.forEach((r) => {
          if (r.checked) value = r.value;
        });
        return value;
      }

      function formatEuro(value) {
        return value.toFixed(2).replace(".", ",");
      }

      function recalculate() {
        const qty250 = parseInt(qty250Input.value, 10) || 0;
        const qty750 = parseInt(qty750Input.value, 10) || 0;

        const price250 = getPriceFromLine(qty250Input);
        const price750 = getPriceFromLine(qty750Input);

        let subtotal = qty250 * price250 + qty750 * price750;

        const deliveryOption = getSelectedDeliveryOption();
        let delivery = 0;

        if (deliveryOption === "livraison" && subtotal > 0) {
          delivery = 5; // 5 ‚Ç¨ de frais de livraison
        }

        const total = subtotal + delivery;
        lastTotal = total;

        subtotalSpan.textContent = formatEuro(subtotal);
        deliverySpan.textContent = formatEuro(delivery);
        totalSpan.textContent = formatEuro(total);
      }

      // √âcouteurs sur les champs
      qty250Input.addEventListener("input", recalculate);
      qty750Input.addEventListener("input", recalculate);
      deliveryRadios.forEach((r) => {
        r.addEventListener("change", recalculate);
      });

      // Bouton de paiement
      payButton.addEventListener("click", function () {
        const deliveryOption = getSelectedDeliveryOption();
        const subtotal = parseFloat(
          subtotalSpan.textContent.replace(",", ".")
        );

        if (!subtotal || subtotal <= 0) {
          alert(
            "Veuillez s√©lectionner au moins une bouteille avant de proc√©der au paiement."
          );
          return;
        }

        if (!deliveryOption) {
          alert(
            "Veuillez choisir entre livraison √† domicile ou retrait √† Ixelles."
          );
          return;
        }

        alert(
          "Montant total √† encoder sur Revolut : " +
            formatEuro(lastTotal) +
            " ‚Ç¨.\n\nVous allez maintenant √™tre redirig√© vers Revolut."
        );

        window.open(REVOLUT_LINK, "_blank");
      });

      // Calcul initial
      recalculate();
    })();
  </script>
</section>
