  <!-- EmailJS library -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- SCRIPT CALCUL + REVOLUT + ENVOI EMAIL + DIAPORAMA -->
  <script>
    (function () {
      /* --------- DIAPORAMA HERO --------- */
      const SLIDESHOW_IMAGES = [
        // Oliveraies & huile d’olive / légumes
        "https://images.pexels.com/photos/1047312/pexels-photo-1047312.jpeg?auto=compress&cs=tinysrgb&w=1600",
        "https://images.pexels.com/photos/143133/pexels-photo-143133.jpeg?auto=compress&cs=tinysrgb&w=1600",
        "https://images.pexels.com/photos/1459339/pexels-photo-1459339.jpeg?auto=compress&cs=tinysrgb&w=1600",
        "https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=1600",
        "https://images.pexels.com/photos/3892172/pexels-photo-3892172.jpeg?auto=compress&cs=tinysrgb&w=1600"
      ];

      const heroImg = document.getElementById("hero-slideshow");
      let slideIndex = 0;

      function nextSlide() {
        if (!heroImg || SLIDESHOW_IMAGES.length <= 1) return;
        slideIndex = (slideIndex + 1) % SLIDESHOW_IMAGES.length;
        heroImg.style.opacity = 0;
        heroImg.style.transform = "scale(1.02)";
        setTimeout(function () {
          heroImg.src = SLIDESHOW_IMAGES[slideIndex];
          heroImg.style.opacity = 1;
          heroImg.style.transform = "scale(1.04)";
        }, 500);
      }

      if (heroImg && SLIDESHOW_IMAGES.length > 1) {
        heroImg.src = SLIDESHOW_IMAGES[0];
        setInterval(nextSlide, 6000);
      }

      /* --------- CONFIG PAIEMENT / EMAIL --------- */
      const PRICE_250 = 8;
      const PRICE_750 = 15;
      const DELIVERY_FEE = 5;

      // Base du lien Revolut (sans montant)
      const REVOLUT_BASE_URL = "https://revolut.me/avanderstratenwaillet";

      // EmailJS
      const EMAILJS_PUBLIC_KEY  = "xtM2H9PprxWX1IWnr";
      const EMAILJS_SERVICE_ID  = "service_5yw7g4q";
      const EMAILJS_TEMPLATE_ID = "template_hyc543e";

      if (typeof emailjs !== "undefined") {
        try {
          emailjs.init(EMAILJS_PUBLIC_KEY);
        } catch (e) {
          console.error("Erreur init EmailJS :", e);
        }
      }

      // ---- ÉLÉMENTS DU FORMULAIRE ----
      const nameInput = document.getElementById("customer-name");
      const emailInput = document.getElementById("customer-email");

      const qty250Input = document.getElementById("qty-250");
      const qty750Input = document.getElementById("qty-750");
      const deliveryRadios = document.querySelectorAll('input[name="delivery-option"]');

      const subtotalSpan = document.getElementById("summary-subtotal");
      const deliverySpan = document.getElementById("summary-delivery");
      const totalSpan = document.getElementById("summary-total");
      const payButton = document.getElementById("pay-button");

      const noteWrapper = document.getElementById("revolut-note-test-wrapper");
      const noteText = document.getElementById("revolut-note-test");

      document.getElementById("price-250-label").textContent = PRICE_250.toString();
      document.getElementById("price-750-label").textContent = PRICE_750.toString();

      function getSelectedDeliveryOption() {
        let value = null;
        deliveryRadios.forEach((r) => {
          if (r.checked) value = r.value;
        });
        return value;
      }

      function formatEuro(value) {
        return value.toFixed(2).replace(".", ",");
      }

      function calculateTotals() {
        const qty250 = parseInt(qty250Input.value, 10) || 0;
        const qty750 = parseInt(qty750Input.value, 10) || 0;

        let subtotal = qty250 * PRICE_250 + qty750 * PRICE_750;

        const deliveryOption = getSelectedDeliveryOption();
        let delivery = 0;

        if (deliveryOption === "livraison" && subtotal > 0) {
          delivery = DELIVERY_FEE;
        }

        const total = subtotal + delivery;
        return { qty250, qty750, subtotal, delivery, total, deliveryOption };
      }

      function recalculate() {
        const totals = calculateTotals();
        subtotalSpan.textContent = formatEuro(totals.subtotal);
        deliverySpan.textContent = formatEuro(totals.delivery);
        totalSpan.textContent = formatEuro(totals.total);
      }

      qty250Input.addEventListener("input", recalculate);
      qty750Input.addEventListener("input", recalculate);
      deliveryRadios.forEach((r) => {
        r.addEventListener("change", recalculate);
      });

      payButton.addEventListener("click", function () {
        const name = (nameInput.value || "").trim();
        const email = (emailInput.value || "").trim();
        const totals = calculateTotals();

        if (!name) {
          alert("Veuillez indiquer votre nom et prénom avant de procéder au paiement.");
          return;
        }

        if (!totals.subtotal || totals.subtotal <= 0) {
          alert("Veuillez sélectionner au moins une bouteille avant de procéder au paiement.");
          return;
        }

        if (!totals.deliveryOption) {
          alert("Veuillez choisir entre livraison à domicile et retrait à Ixelles.");
          return;
        }

        const amountRounded = Math.round(totals.total * 100) / 100;

        const deliveryText = totals.deliveryOption === "livraison"
          ? "Livraison (Uccle / Ixelles / ~3 km, +5 €)"
          : "Retrait à Ixelles";

        const recapLines = [
          "Nouvelle commande huile de Fany",
          "",
          "Nom : " + name,
          "Email : " + (email || "non communiqué"),
          "",
          "Quantité 250 ml : " + totals.qty250,
          "Quantité 750 ml : " + totals.qty750,
          "Option : " + deliveryText,
          "",
          "Sous-total bouteilles : " + formatEuro(totals.subtotal) + " €",
          "Frais de livraison : " + formatEuro(totals.delivery) + " €",
          "Total : " + formatEuro(amountRounded) + " €"
        ];

        const recapText = recapLines.join("\n");

        // Affichage du récap sous le bouton (test / debug)
        noteWrapper.style.display = "block";
        noteText.textContent = recapText;

        // Envoi de l'e-mail via EmailJS
        if (typeof emailjs !== "undefined") {
          const templateParams = {
            from_name: name,
            from_email: email || "non communiqué",
            message: recapText,
            qty_250: totals.qty250,
            qty_750: totals.qty750,
            delivery: deliveryText,
            total: formatEuro(amountRounded)
          };

          emailjs
            .send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
            .then(
              function (response) {
                console.log("EmailJS OK", response.status, response.text);
              },
              function (error) {
                console.error("Erreur EmailJS", error);
              }
            );
        }

        // ----- Lien Revolut AVEC MONTANT PRÉ-REMPLI -----
        // Comme tes montants sont des entiers, on peut utiliser  "XXeur"
        const amountInteger = Math.round(amountRounded); // ex: 23
        const revolutPayUrl = REVOLUT_BASE_URL + "/" + amountInteger + "eur";

        alert(
          "Montant total à payer : " +
            formatEuro(amountRounded) +
            " €.\n\nUne nouvelle fenêtre va s’ouvrir pour finaliser votre paiement sur Revolut.\n" +
            "Dans Revolut, vous pouvez coller ce motif de paiement :\n\n" +
            "Huile Fany – " + name
        );

        window.open(revolutPayUrl, "_blank");
      });

      recalculate();
    })();
  </script>
